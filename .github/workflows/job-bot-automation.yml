name: Simple Job Bot

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch: # Allow manual trigger
    inputs:
      job_limit:
        description: 'Maximum number of jobs to apply to'
        required: false
        default: '10'
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/**'

env:
  PYTHON_VERSION: '3.11'
  FIREFOX_VERSION: 'latest'

jobs:
  simple-job-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Primary Run"
            job_limit: ${{ github.event.inputs.job_limit || '10' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: Install Firefox and geckodriver
      run: |
        sudo apt-get update
        sudo snap remove firefox 2>/dev/null || true
        sudo apt-get install -y software-properties-common xvfb
        
        # Install Firefox ESR
        sudo add-apt-repository -y ppa:mozillateam/ppa
        echo 'Package: *' | sudo tee /etc/apt/preferences.d/mozilla-firefox > /dev/null
        echo 'Pin: release o=LP-PPA-mozillateam' | sudo tee -a /etc/apt/preferences.d/mozilla-firefox > /dev/null
        echo 'Pin-Priority: 1001' | sudo tee -a /etc/apt/preferences.d/mozilla-firefox > /dev/null
        sudo apt-get update
        sudo apt-get install -y firefox
        
        # Install geckodriver
        GECKO_VERSION=$(curl -s "https://api.github.com/repos/mozilla/geckodriver/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -L --fail --retry 3 "https://github.com/mozilla/geckodriver/releases/download/v${GECKO_VERSION}/geckodriver-v${GECKO_VERSION}-linux64.tar.gz" -o /tmp/geckodriver.tar.gz
        sudo tar -xzf /tmp/geckodriver.tar.gz -C /usr/local/bin/
        sudo chmod +x /usr/local/bin/geckodriver
        
        # Verify installation
        geckodriver --version
        firefox --version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment
      run: |
        cat > .env << EOF
        PERSONAL_FULL_NAME=${{ secrets.PERSONAL_FULL_NAME }}
        PERSONAL_EMAIL=${{ secrets.PERSONAL_EMAIL }}
        PERSONAL_PHONE=${{ secrets.PERSONAL_PHONE }}
        PERSONAL_LINKEDIN=${{ secrets.PERSONAL_LINKEDIN }}
        PERSONAL_GITHUB=${{ secrets.PERSONAL_GITHUB }}
        PERSONAL_LOCATION=${{ secrets.PERSONAL_LOCATION }}
        TWITTER_EMAIL=${{ secrets.TWITTER_EMAIL }}
        TWITTER_PASSWORD=${{ secrets.TWITTER_PASSWORD }}
        INDEED_EMAIL=${{ secrets.INDEED_EMAIL }}
        INDEED_PASSWORD=${{ secrets.INDEED_PASSWORD }}
        DICE_EMAIL=${{ secrets.DICE_EMAIL }}
        DICE_PASSWORD=${{ secrets.DICE_PASSWORD }}
        WEWORKREMOTELY_EMAIL=${{ secrets.WEWORKREMOTELY_EMAIL }}
        WEWORKREMOTELY_PASSWORD=${{ secrets.WEWORKREMOTELY_PASSWORD }}
        TURING_EMAIL=${{ secrets.TURING_EMAIL }}
        TURING_PASSWORD=${{ secrets.TURING_PASSWORD }}
        REMOTEOK_EMAIL=${{ secrets.REMOTEOK_EMAIL }}
        REMOTEOK_PASSWORD=${{ secrets.REMOTEOK_PASSWORD }}
        FLEXJOBS_EMAIL=${{ secrets.FLEXJOBS_EMAIL }}
        FLEXJOBS_PASSWORD=${{ secrets.FLEXJOBS_PASSWORD }}
        JOB_TITLES=DevOps Engineer,Cloud Engineer,Site Reliability Engineer (SRE),Infrastructure Engineer,Platform Engineer,AWS Engineer,Kubernetes Administrator,CI/CD Engineer,Linux Systems Engineer,Cloud Automation Engineer,Junior DevOps Associate,Remote DevOps Intern
        SKILLS=DevOps,AWS,Docker,Kubernetes,Python,Linux,CI/CD,Jenkins,Terraform
        SALARY_MIN=50000
        REMOTE_ONLY=false
        EXPERIENCE_LEVEL=Entry and Mid
        EOF
        mkdir -p application_proofs

    - name: Run simple job bot
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        sleep 3
        echo "ü§ñ Starting simple job bot..."
        python simple_job_bot.py
        echo "‚úÖ Job bot completed!"
      env:
        PYTHONPATH: .
        GITHUB_ACTIONS: true
        PERSONAL_FULL_NAME: ${{ secrets.PERSONAL_FULL_NAME }}
        PERSONAL_EMAIL: ${{ secrets.PERSONAL_EMAIL }}
        PERSONAL_PHONE: ${{ secrets.PERSONAL_PHONE }}
        PERSONAL_LINKEDIN: ${{ secrets.PERSONAL_LINKEDIN }}
        PERSONAL_GITHUB: ${{ secrets.PERSONAL_GITHUB }}
        PERSONAL_LOCATION: ${{ secrets.PERSONAL_LOCATION }}
        TWITTER_EMAIL: ${{ secrets.TWITTER_EMAIL }}
        TWITTER_PASSWORD: ${{ secrets.TWITTER_PASSWORD }}
        INDEED_EMAIL: ${{ secrets.INDEED_EMAIL }}
        INDEED_PASSWORD: ${{ secrets.INDEED_PASSWORD }}
        DICE_EMAIL: ${{ secrets.DICE_EMAIL }}
        DICE_PASSWORD: ${{ secrets.DICE_PASSWORD }}
        WEWORKREMOTELY_EMAIL: ${{ secrets.WEWORKREMOTELY_EMAIL }}
        WEWORKREMOTELY_PASSWORD: ${{ secrets.WEWORKREMOTELY_PASSWORD }}
        TURING_EMAIL: ${{ secrets.TURING_EMAIL }}
        TURING_PASSWORD: ${{ secrets.TURING_PASSWORD }}
        REMOTEOK_EMAIL: ${{ secrets.REMOTEOK_EMAIL }}
        REMOTEOK_PASSWORD: ${{ secrets.REMOTEOK_PASSWORD }}
        FLEXJOBS_EMAIL: ${{ secrets.FLEXJOBS_EMAIL }}
        FLEXJOBS_PASSWORD: ${{ secrets.FLEXJOBS_PASSWORD }}

    - name: Upload job results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: job-bot-results-${{ github.run_number }}
        path: |
          application_proofs/
          applications.txt
        retention-days: 4

    - name: Job completion summary
      if: always()
      run: |
        echo "üéâ Simple job bot run completed at $(date)"
        echo "üìã Results and screenshots uploaded as artifacts"
        echo "‚è∞ Next automated run in ~2 hours"
